<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--# Google Font(Noto Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@1,100&display=swap" rel="stylesheet">
    <!--# jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!--# Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!--# moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <title>robot value</title>
    <style>

    </style>
</head>

<body style="background-color: #333">

    <div id="myDiv" class="chart-div">
        <!-- Append graph here -->
    </div>

    <script>
        window.onload = () => {
            getDataAndDrawChart();

            setInterval(() => {
                getDataAndDrawChart();
            }, 5000);
        }

        const URL = `http://211.219.71.59:8086/query?db=robot_sensor&q=select * from robot_sensor_measure order by time desc`

        const getDataAndDrawChart = () => {

            const getData = async () => {
                const response = await fetch(URL);
                const resJSON = await response.json();
                return resJSON;
            }

            getData().then(result => {
                // console.log(result)
                const columns = result.results[0].series[0].columns;
                const values = result.results[0].series[0].values;
                // console.log(columns)
                // console.log(values)


                let time = [];
                let sensor1 = [];
                let sensor2 = [];
                let sensor3 = [];
                let sensor4 = [];
                let sensor5 = [];
                let sensor6 = [];

                values.forEach((element, index) => {
                    // console.log(element)
                    time[index] = element[0]
                    sensor1[index] = element[1]
                    sensor2[index] = element[2]
                    sensor3[index] = element[3]
                    sensor4[index] = element[4]
                    sensor5[index] = element[5]
                    sensor6[index] = element[6]
                });
                time = time.reverse();
                // console.log(time)

                drawChart(time, sensor1, sensor2, sensor3, sensor4, sensor5, sensor6);
            })

            const drawChart = (time, sensor1, sensor2, sensor3, sensor4, sensor5, sensor6) => {

                const traceArr = []

                for (let i = 0; i < 6; i++) {
                    const trace = {
                        type: 'scatter',
                        mode: 'lines',
                        name: `sensor_${i}`,
                        x: time,
                        y: `sensor${i}`,
                        line: { width: 2 },
                    }
                    traceArr.push(trace);
                }


                let data = [];
                data.push(traceArr[0], traceArr[1], traceArr[2], traceArr[3], traceArr[4], traceArr[5]);


                //* 레이아웃
                let layout = {
                    title: false,
                    height: 380,
                    xaxis: {
                        range: time,
                        zeroline: false,
                        ticks: "inside",              // 글씨를 안쪽으로 할지 바깥쪽으로 할지
                        // tickcolor: 'rgba(0,0,0,0)',
                        gridcolor: '#fff',
                        nticks: 6
                        // tick0: 100,
                        // dtick: 10
                    },
                    yaxis: {
                        zeroline: false,
                        ticks: "outside",
                        gridcolor: '#fff',
                        nticks: 3,
                        range: [0, 180]
                    },
                    margin: { t: 30, b: 70, l: 70, r: 50, pad: 10 },
                    showlegend: false,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Noto Sans KR', size: 20, color: '#fff', weight: 800 },
                }

                Plotly.newPlot('myDiv', data, layout, { displayModeBar: false });
            }

        }

    </script>
</body>

</html>